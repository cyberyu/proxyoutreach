<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confusion Matrix Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Confusion Matrix Test</h2>
        
        <div class="mb-3">
            <button class="btn btn-primary" onclick="testConfusionMatrix()">Test Confusion Matrix</button>
            <button class="btn btn-secondary" onclick="showProposalConfusion()">Show Confusion Matrix</button>
            <button class="btn btn-info" onclick="checkElements()">Check Elements</button>
        </div>
        
        <div id="testResults" class="mb-3"></div>
        
        <!-- Include the confusion matrix container from main page -->
        <div id="confusionMatrixContainer" style="display: none; margin-top: 1rem;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-chart-bar me-2"></i>Proposal Confusion Matrix</h4>
                <button class="btn btn-secondary" onclick="hideConfusionMatrix()">
                    <i class="fas fa-arrow-left me-1"></i>Back to Proposals
                </button>
            </div>
            
            <!-- Confusion Matrix Content -->
            <div class="row">
                <!-- Left column: Confusion Matrix + All Metrics -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Confusion Matrix</h6>
                        </div>
                        <div class="card-body">
                            <div id="confusionMatrixTable"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Right column: Space for additional metrics -->
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0 text-muted"><i class="fas fa-chart-line me-2"></i>Additional Metrics</h6>
                        </div>
                        <div class="card-body text-center">
                            <h5 class="text-muted mb-3">Space for Future Metrics</h5>
                            <p class="text-muted">Additional performance metrics, model comparisons, or custom analytics will be displayed here.</p>
                            <div class="mt-4">
                                <div class="placeholder-glow">
                                    <span class="placeholder col-8 mb-2"></span>
                                    <span class="placeholder col-6 mb-2"></span>
                                    <span class="placeholder col-7"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom row: Classification Metrics -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Classification Metrics</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="metric-card p-3 bg-light rounded">
                                        <h5 class="text-primary mb-1" id="accuracyMetric">-</h5>
                                        <small class="text-muted">Accuracy</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card p-3 bg-light rounded">
                                        <h5 class="text-success mb-1" id="precisionMetric">-</h5>
                                        <small class="text-muted">Precision</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card p-3 bg-light rounded">
                                        <h5 class="text-warning mb-1" id="recallMetric">-</h5>
                                        <small class="text-muted">Recall</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric-card p-3 bg-light rounded">
                                        <h5 class="text-info mb-1" id="f1Metric">-</h5>
                                        <small class="text-muted">F1-Score</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fake proposals section for testing -->
        <div id="proposals-section" style="display: block;">
            <h3>Proposals Section (for testing)</h3>
            <p>This section should be hidden when confusion matrix is shown.</p>
        </div>
    </div>

    <script>
        // Include the necessary functions from script.js
        
        // Calculate metrics from confusion matrix
        function calculateMetrics(matrix) {
            const tp = matrix.true_positive || 0;
            const fp = matrix.false_positive || 0;
            const fn = matrix.false_negative || 0;
            const tn = matrix.true_negative || 0;
            
            const total = tp + fp + fn + tn;
            const accuracy = total > 0 ? (tp + tn) / total : 0;
            const precision = (tp + fp) > 0 ? tp / (tp + fp) : 0;
            const recall = (tp + fn) > 0 ? tp / (tp + fn) : 0;
            const f1_score = (precision + recall) > 0 ? 2 * (precision * recall) / (precision + recall) : 0;
            
            return { accuracy, precision, recall, f1_score };
        }

        // Render confusion matrix table and metrics
        function renderConfusionMatrix(confusionMatrix, metrics) {
            const container = document.getElementById('confusionMatrixTable');
            
            // Create confusion matrix table with fixed square dimensions + metrics below
            let html = `
                <table class="table table-bordered text-center mb-3" style="width: 400px; height: 400px; margin: 0 auto;">
                    <thead>
                        <tr>
                            <th class="bg-light" style="width: 133px; height: 50px;"></th>
                            <th class="bg-primary text-white" style="width: 133px; height: 50px;">Predicted NO</th>
                            <th class="bg-primary text-white" style="width: 134px; height: 50px;">Predicted YES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th class="bg-primary text-white" style="height: 175px;">Actual NO</th>
                            <td style="height: 175px; vertical-align: middle; font-size: 24px; font-weight: bold;">${confusionMatrix.tn}</td>
                            <td style="height: 175px; vertical-align: middle; font-size: 24px; font-weight: bold;">${confusionMatrix.fp}</td>
                        </tr>
                        <tr>
                            <th class="bg-primary text-white" style="height: 175px;">Actual YES</th>
                            <td style="height: 175px; vertical-align: middle; font-size: 24px; font-weight: bold;">${confusionMatrix.fn}</td>
                            <td style="height: 175px; vertical-align: middle; font-size: 24px; font-weight: bold;">${confusionMatrix.tp}</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- All Metrics in 2x2 Grid -->
                <div class="row g-2">
                    <div class="col-6">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center p-2">
                                <h6 class="card-title mb-1">Accuracy</h6>
                                <h5 class="mb-0">90.0%</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center p-2">
                                <h6 class="card-title mb-1">Precision</h6>
                                <h5 class="mb-0">87.6%</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center p-2">
                                <h6 class="card-title mb-1">Recall</h6>
                                <h5 class="mb-0">91.4%</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-secondary text-white">
                            <div class="card-body text-center p-2">
                                <h6 class="card-title mb-1">F1-Score</h6>
                                <h5 class="mb-0">89.5%</h5>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Show placeholder matrix
        function showPlaceholderMatrix() {
            const placeholderData = {
                matrix: {
                    'true_positive': 85,
                    'false_positive': 12,
                    'false_negative': 8,
                    'true_negative': 95
                }
            };
            
            placeholderData.metrics = calculateMetrics(placeholderData.matrix);
            renderConfusionMatrix(placeholderData);
            
            const tableContainer = document.getElementById('confusionMatrixTable');
            if (!tableContainer.querySelector('.demo-notice')) {
                const notice = document.createElement('div');
                notice.className = 'alert alert-info mt-3 demo-notice';
                notice.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Demo Data:</strong> This is placeholder data showing example confusion matrix results.
                `;
                tableContainer.appendChild(notice);
            }
        }

        // Show confusion matrix
        function showProposalConfusion(proposalId = null) {
            console.log('showProposalConfusion called with proposalId:', proposalId);
            
            const confusionContainer = document.getElementById('confusionMatrixContainer');
            const proposalsSection = document.getElementById('proposals-section');
            const confusionTableDiv = document.getElementById('confusionMatrixTable');
            
            console.log('Elements found:', {
                confusionContainer: !!confusionContainer,
                proposalsSection: !!proposalsSection,
                confusionTableDiv: !!confusionTableDiv
            });
            
            if (!confusionContainer) {
                alert('confusionMatrixContainer not found!');
                return;
            }
            
            if (!confusionTableDiv) {
                alert('confusionMatrixTable not found!');
                return;
            }
            
            // Hide proposals section and show confusion matrix
            if (proposalsSection) proposalsSection.style.display = 'none';
            confusionContainer.style.display = 'block';
            
            // Show loading state briefly
            confusionTableDiv.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading confusion matrix...</p>
                </div>
            `;
            
            // Clear metrics
            ['accuracyMetric', 'precisionMetric', 'recallMetric', 'f1Metric'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '-';
                }
            });
            
            // Show placeholder data after a brief delay
            setTimeout(() => {
                showPlaceholderMatrix();
            }, 800);
        }

        // Hide confusion matrix
        function hideConfusionMatrix() {
            document.getElementById('confusionMatrixContainer').style.display = 'none';
            document.getElementById('proposals-section').style.display = 'block';
        }

        // Test function
        function testConfusionMatrix() {
            console.log('=== TESTING CONFUSION MATRIX ===');
            
            const elements = {
                confusionContainer: document.getElementById('confusionMatrixContainer'),
                proposalsSection: document.getElementById('proposals-section'),
                confusionTableDiv: document.getElementById('confusionMatrixTable'),
                accuracyMetric: document.getElementById('accuracyMetric'),
                precisionMetric: document.getElementById('precisionMetric'),
                recallMetric: document.getElementById('recallMetric'),
                f1Metric: document.getElementById('f1Metric')
            };
            
            console.log('Elements check:', elements);
            
            const results = document.getElementById('testResults');
            
            if (elements.confusionContainer && elements.confusionTableDiv) {
                console.log('All required elements found, testing display...');
                
                elements.confusionContainer.style.display = 'block';
                if (elements.proposalsSection) {
                    elements.proposalsSection.style.display = 'none';
                }
                
                showPlaceholderMatrix();
                
                results.innerHTML = '<div class="alert alert-success">✅ Test successful! Confusion matrix should be visible above.</div>';
                console.log('Confusion matrix should now be visible');
                return true;
            } else {
                const missing = Object.keys(elements).filter(key => !elements[key]);
                results.innerHTML = `<div class="alert alert-danger">❌ Test failed! Missing elements: ${missing.join(', ')}</div>`;
                console.error('Missing required elements:', missing);
                return false;
            }
        }

        // Check elements function
        function checkElements() {
            const elements = {
                confusionContainer: document.getElementById('confusionMatrixContainer'),
                proposalsSection: document.getElementById('proposals-section'),
                confusionTableDiv: document.getElementById('confusionMatrixTable'),
                accuracyMetric: document.getElementById('accuracyMetric'),
                precisionMetric: document.getElementById('precisionMetric'),
                recallMetric: document.getElementById('recallMetric'),
                f1Metric: document.getElementById('f1Metric')
            };
            
            const results = document.getElementById('testResults');
            let html = '<div class="alert alert-info"><h6>Element Check Results:</h6><ul>';
            
            for (const [name, element] of Object.entries(elements)) {
                const status = element ? '✅ Found' : '❌ Missing';
                html += `<li><strong>${name}</strong>: ${status}</li>`;
            }
            
            html += '</ul></div>';
            results.innerHTML = html;
        }
    </script>
</body>
</html>
